{% extends 'base.html' %}

{% block title %}Super Admin Dashboard - Life Link Nepal{% endblock %}

{% block extra_css %}
<style>
:root {
    --primary-blue: #2563eb;
    --primary-red: #dc2626;
    --gradient-heart: linear-gradient(135deg, #2563eb 0%, #dc2626 100%);
    --white: #ffffff;
    --light-bg: #f8fafc;
    --text-dark: #0f172a;
    --text-muted: #64748b;
    --border-color: #e2e8f0;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #dc2626;
    --info: #0ea5e9;
    --gold: #fbbf24;
    --silver: #9ca3af;
    --bronze: #d97706;
    --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    background: var(--light-bg);
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    color: var(--text-dark);
    line-height: 1.6;
    min-height: 100vh;
    overflow-x: hidden;
}

/* Sidebar */
.admin-sidebar {
    position: fixed;
    left: 0;
    top: 0;
    width: 280px;
    height: 100vh;
    background: linear-gradient(180deg, #1e40af 0%, #1e3a8a 100%);
    color: white;
    padding: 0;
    box-shadow: var(--shadow-xl);
    z-index: 1000;
    overflow-y: auto;
}

.sidebar-header {
    padding: 32px 24px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    text-align: center;
    background: rgba(0, 0, 0, 0.1);
}

.sidebar-header h3 {
    font-size: 22px;
    font-weight: 800;
    margin: 0;
    color: white;
    letter-spacing: -0.5px;
}

.sidebar-header p {
    font-size: 13px;
    opacity: 0.7;
    margin: 8px 0 0 0;
    font-weight: 500;
}

.sidebar-menu {
    padding: 24px 0;
}

.menu-item {
    display: flex;
    align-items: center;
    padding: 16px 24px;
    color: rgba(255, 255, 255, 0.75);
    text-decoration: none;
    transition: all 0.2s ease;
    border-left: 4px solid transparent;
    cursor: pointer;
    font-weight: 500;
    margin: 4px 0;
}

.menu-item:hover {
    background: rgba(255, 255, 255, 0.1);
    color: white;
    border-left-color: #fbbf24;
}

.menu-item.active {
    background: rgba(255, 255, 255, 0.15);
    color: white;
    border-left-color: var(--primary-red);
}

.menu-item i {
    font-size: 20px;
    margin-right: 14px;
    width: 24px;
}

.menu-item span {
    flex: 1;
    font-weight: 600;
}

.menu-badge {
    background: var(--primary-red);
    color: white;
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 700;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    animation: pulse-badge 2s infinite;
}

@keyframes pulse-badge {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); box-shadow: 0 2px 8px rgba(220, 38, 38, 0.4); }
}

/* Main Content */
.admin-main {
    margin-left: 280px;
    min-height: 100vh;
    padding: 0;
    background: var(--light-bg);
}

.top-navbar {
    background: white;
    padding: 20px 40px;
    box-shadow: var(--shadow-md);
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 100;
}

.search-bar {
    flex: 1;
    max-width: 500px;
    position: relative;
}

.search-bar input {
    width: 100%;
    padding: 12px 20px 12px 48px;
    border: 2px solid var(--border-color);
    border-radius: 12px;
    font-size: 15px;
    transition: all 0.3s ease;
    background: var(--light-bg);
}

.search-bar input:focus {
    outline: none;
    border-color: var(--primary-blue);
    background: white;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.search-bar i {
    position: absolute;
    left: 18px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-muted);
    font-size: 18px;
}

.search-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 2px solid var(--border-color);
    border-radius: 12px;
    margin-top: 8px;
    max-height: 400px;
    overflow-y: auto;
    box-shadow: var(--shadow-xl);
    z-index: 1000;
    display: none;
}

.search-results.active {
    display: block;
}

.search-result-item {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: background 0.2s ease;
}

.search-result-item:hover {
    background: var(--light-bg);
}

.search-result-item:last-child {
    border-bottom: none;
}

.search-result-type {
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 4px;
    letter-spacing: 0.5px;
}

.search-result-title {
    font-weight: 700;
    color: var(--text-dark);
    font-size: 15px;
}

.search-result-subtitle {
    font-size: 13px;
    color: var(--text-muted);
    margin-top: 4px;
}

.admin-profile {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 8px 16px;
    border-radius: 12px;
    transition: background 0.3s ease;
}

.admin-profile:hover {
    background: var(--light-bg);
}

.admin-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: linear-gradient(135deg, #2563eb 0%, #dc2626 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 800;
    font-size: 18px;
    box-shadow: var(--shadow-md);
}

/* Content Area */
.content-area {
    padding: 40px;
}

.page-header {
    margin-bottom: 32px;
}

.page-header h2 {
    font-size: 32px;
    font-weight: 800;
    color: var(--text-dark);
    margin-bottom: 8px;
    letter-spacing: -0.5px;
}

.page-header p {
    color: var(--text-muted);
    font-size: 15px;
    font-weight: 500;
}

/* Stats Cards */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 24px;
    margin-bottom: 40px;
}

.stat-card {
    background: white;
    border-radius: 16px;
    padding: 28px;
    box-shadow: var(--shadow-md);
    transition: all 0.3s ease;
    border: 1px solid var(--border-color);
}

.stat-card:hover {
    transform: translateY(-6px);
    box-shadow: var(--shadow-xl);
}

.stat-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
}

.stat-icon {
    width: 56px;
    height: 56px;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 26px;
    box-shadow: var(--shadow-md);
}

.stat-icon.donors {
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
    color: white;
}

.stat-icon.hospitals {
    background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    color: white;
}

.stat-icon.requests {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
}

.stat-icon.completed {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
}

.stat-icon.fulfilled {
    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
    color: white;
}

.stat-content h3 {
    font-size: 36px;
    font-weight: 800;
    color: var(--text-dark);
    margin-bottom: 4px;
    letter-spacing: -1px;
}

.stat-content p {
    color: var(--text-muted);
    font-size: 14px;
    margin: 0;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Content Sections */
.content-section {
    background: white;
    border-radius: 16px;
    padding: 28px;
    box-shadow: var(--shadow-md);
    margin-bottom: 28px;
    border: 1px solid var(--border-color);
}

.section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
    padding-bottom: 20px;
    border-bottom: 2px solid var(--border-color);
}

.section-header h3 {
    font-size: 20px;
    font-weight: 800;
    color: var(--text-dark);
    margin: 0;
    letter-spacing: -0.3px;
}

.filter-tabs {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.filter-tab {
    padding: 10px 18px;
    border: 2px solid var(--border-color);
    border-radius: 10px;
    background: white;
    color: var(--text-muted);
    font-size: 13px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s ease;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.filter-tab:hover {
    background: var(--light-bg);
    border-color: var(--primary-blue);
    color: var(--primary-blue);
}

.filter-tab.active {
    background: var(--primary-blue);
    border-color: var(--primary-blue);
    color: white;
    box-shadow: 0 4px 6px rgba(37, 99, 235, 0.3);
}

/* Terminal Style Blood Requests */
.terminal-requests {
    background: #1a1a1a;
    border-radius: 12px;
    padding: 24px;
    font-family: 'Courier New', monospace;
    color: #00ff00;
    box-shadow: inset 0 0 20px rgba(0, 255, 0, 0.1);
    margin-bottom: 24px;
    max-height: 500px;
    overflow-y: auto;
}

.terminal-header {
    color: #00ff00;
    font-weight: bold;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid #00ff00;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.terminal-time {
    color: #ffff00;
    font-size: 12px;
}

.terminal-request {
    margin-bottom: 16px;
    padding: 12px;
    background: rgba(0, 255, 0, 0.05);
    border-left: 3px solid #ff0000;
    animation: terminal-blink 2s infinite;
}

.terminal-request.urgent {
    border-left-color: #ff0000;
    animation: urgent-blink 1s infinite;
}

.terminal-request.fulfilled {
    border-left-color: #00ff00;
    opacity: 0.6;
    animation: none;
}

@keyframes terminal-blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

@keyframes urgent-blink {
    0%, 100% { background: rgba(255, 0, 0, 0.1); }
    50% { background: rgba(255, 0, 0, 0.2); }
}

.terminal-line {
    margin: 4px 0;
    line-height: 1.6;
}

.terminal-label {
    color: #00ffff;
    font-weight: bold;
}

.terminal-value {
    color: #ffffff;
}

.terminal-urgent {
    color: #ff0000;
    font-weight: bold;
    animation: text-blink 1s infinite;
}

@keyframes text-blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.terminal-fulfilled {
    color: #00ff00;
    font-weight: bold;
}

/* Top Donors Leaderboard */
.leaderboard-card {
    background: white;
    border-radius: 16px;
    padding: 28px;
    box-shadow: var(--shadow-md);
    margin-bottom: 28px;
    border: 1px solid var(--border-color);
}

.leaderboard-item {
    display: flex;
    align-items: center;
    padding: 20px;
    margin-bottom: 16px;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-radius: 12px;
    transition: all 0.3s ease;
    border: 2px solid var(--border-color);
}

.leaderboard-item:hover {
    transform: translateX(8px);
    box-shadow: var(--shadow-lg);
}

.leaderboard-item.rank-1 {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border-color: var(--gold);
}

.leaderboard-item.rank-2 {
    background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
    border-color: var(--silver);
}

.leaderboard-item.rank-3 {
    background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%);
    border-color: var(--bronze);
}

.rank-badge {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 800;
    font-size: 20px;
    margin-right: 16px;
    box-shadow: var(--shadow-md);
}

.rank-badge.rank-1 {
    background: linear-gradient(135deg, var(--gold), #f59e0b);
    color: #7c2d12;
}

.rank-badge.rank-2 {
    background: linear-gradient(135deg, var(--silver), #6b7280);
    color: #1f2937;
}

.rank-badge.rank-3 {
    background: linear-gradient(135deg, var(--bronze), #ea580c);
    color: #7c2d12;
}

.rank-badge.rank-other {
    background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
    color: #3730a3;
}

.donor-stars {
    display: flex;
    gap: 4px;
    margin-top: 8px;
}

.star {
    color: var(--gold);
    font-size: 16px;
    animation: star-twinkle 2s infinite;
}

@keyframes star-twinkle {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.donation-count {
    background: linear-gradient(135deg, #dc2626, #b91c1c);
    color: white;
    padding: 6px 14px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 14px;
    margin-left: auto;
    box-shadow: var(--shadow-sm);
}

/* Analytics Charts */
.analytics-chart {
    background: white;
    border-radius: 16px;
    padding: 28px;
    box-shadow: var(--shadow-md);
    margin-bottom: 28px;
    border: 1px solid var(--border-color);
}

.chart-bar {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
}

.chart-label {
    min-width: 120px;
    font-weight: 700;
    color: var(--text-dark);
}

.chart-bar-container {
    flex: 1;
    background: var(--light-bg);
    border-radius: 8px;
    height: 32px;
    position: relative;
    overflow: hidden;
}

.chart-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary-blue), var(--primary-red));
    border-radius: 8px;
    transition: width 1s ease;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding-right: 12px;
    color: white;
    font-weight: 700;
    font-size: 14px;
}

.chart-bar-fill.fulfilled {
    background: linear-gradient(90deg, var(--success), #059669);
}

/* Table Styles */
.data-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    overflow: hidden;
}

.data-table thead {
    background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
}

.data-table th {
    padding: 16px 20px;
    text-align: left;
    font-size: 12px;
    font-weight: 800;
    color: var(--text-dark);
    text-transform: uppercase;
    letter-spacing: 1px;
    border-bottom: 2px solid var(--border-color);
}

.data-table td {
    padding: 20px;
    border-bottom: 1px solid var(--border-color);
    font-size: 14px;
    color: var(--text-dark);
    word-wrap: break-word;
}

.data-table tbody tr {
    transition: all 0.2s ease;
}

.data-table tbody tr:hover {
    background: #fafbfc;
    transform: scale(1.01);
}

.donor-info,
.hospital-info {
    display: flex;
    align-items: center;
    gap: 14px;
}

.donor-avatar,
.hospital-avatar {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 800;
    color: white;
    font-size: 16px;
    flex-shrink: 0;
    box-shadow: var(--shadow-md);
}

.donor-avatar {
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
}

.hospital-avatar {
    background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
}

.info-text h4 {
    font-size: 15px;
    font-weight: 700;
    margin: 0 0 4px 0;
    color: var(--text-dark);
}

.info-text p {
    font-size: 13px;
    color: var(--text-muted);
    margin: 0;
    font-weight: 500;
}

.blood-type {
    padding: 8px 14px;
    border-radius: 10px;
    font-weight: 800;
    font-size: 14px;
    display: inline-block;
    white-space: nowrap;
    letter-spacing: 0.5px;
}

.blood-type.positive {
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    color: #dc2626;
    border: 2px solid #fca5a5;
}

.blood-type.negative {
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    color: #2563eb;
    border: 2px solid #93c5fd;
}

.status-badge {
    padding: 8px 14px;
    border-radius: 10px;
    font-size: 11px;
    font-weight: 800;
    display: inline-block;
    white-space: nowrap;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-badge.active {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    color: #065f46;
    border: 2px solid #6ee7b7;
}

.status-badge.pending {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    color: #92400e;
    border: 2px solid #fcd34d;
}

.status-badge.matched {
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    color: #1e40af;
    border: 2px solid #93c5fd;
}

.status-badge.completed,
.status-badge.fulfilled {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    color: #065f46;
    border: 2px solid #6ee7b7;
}

.status-badge.urgent,
.status-badge.high,
.status-badge.critical {
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    color: #991b1b;
    border: 2px solid #fca5a5;
}

.status-badge.medium {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    color: #92400e;
    border: 2px solid #fcd34d;
}

.status-badge.low {
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    color: #1e40af;
    border: 2px solid #93c5fd;
}

/* Action Buttons */
.action-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.btn-action {
    padding: 10px 16px;
    border: none;
    border-radius: 10px;
    font-size: 13px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    white-space: nowrap;
    box-shadow: var(--shadow-sm);
}

.btn-notify {
    background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    color: white;
}

.btn-notify:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(37, 99, 235, 0.4);
}

.btn-notify:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-view {
    background: var(--light-bg);
    color: var(--text-dark);
    border: 2px solid var(--border-color);
}

.btn-view:hover {
    background: white;
    border-color: var(--primary-blue);
    color: var(--primary-blue);
    box-shadow: var(--shadow-md);
}

.btn-approve {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
}

.btn-approve:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
}

.btn-reject,
.btn-fulfill {
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
    color: white;
}

.btn-reject:hover,
.btn-fulfill:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(220, 38, 38, 0.4);
}

.btn-fulfill:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Blood Type Chart */
.blood-chart {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 20px;
    padding: 24px 0;
}

.blood-chart-item {
    text-align: center;
    padding: 24px;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-radius: 14px;
    transition: all 0.3s ease;
    border: 2px solid var(--border-color);
}

.blood-chart-item:hover {
    transform: translateY(-6px);
    box-shadow: var(--shadow-lg);
    border-color: var(--primary-blue);
}

.blood-chart-item .blood-type {
    font-size: 28px;
    font-weight: 800;
    margin-bottom: 12px;
    display: block;
}

.blood-chart-item .count {
    font-size: 36px;
    font-weight: 800;
    color: var(--text-dark);
    display: block;
    margin-bottom: 4px;
    letter-spacing: -1px;
}

.blood-chart-item .label {
    font-size: 12px;
    color: var(--text-muted);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Monthly Stats Grid */
.monthly-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
}

.monthly-stat-card {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    padding: 24px;
    border-radius: 14px;
    border-left: 5px solid var(--primary-blue);
    box-shadow: var(--shadow-md);
    transition: all 0.3s ease;
}

.monthly-stat-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
}

.monthly-stat-card h4 {
    font-size: 13px;
    color: var(--text-muted);
    margin: 0 0 12px 0;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.monthly-stat-card .value {
    font-size: 32px;
    font-weight: 800;
    color: var(--text-dark);
    letter-spacing: -1px;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 80px 20px;
    color: var(--text-muted);
}

.empty-state i {
    font-size: 72px;
    opacity: 0.3;
    margin-bottom: 24px;
    color: var(--primary-blue);
}

.empty-state h4 {
    font-size: 20px;
    margin-bottom: 12px;
    font-weight: 700;
    color: var(--text-dark);
}

.empty-state p {
    font-size: 15px;
    font-weight: 500;
}

/* Loading Spinner */
.loading {
    text-align: center;
    padding: 60px;
}

.spinner {
    width: 48px;
    height: 48px;
    border: 5px solid var(--border-color);
    border-top-color: var(--primary-blue);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto 20px;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Toggle Switch */
.toggle-switch {
    position: relative;
    display: inline-block;
    width: 56px;
    height: 28px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #cbd5e1;
    border-radius: 28px;
    transition: 0.3s;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 22px;
    width: 22px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    border-radius: 50%;
    transition: 0.3s;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.toggle-switch input:checked + .toggle-slider {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}

.toggle-switch input:checked + .toggle-slider:before {
    transform: translateX(28px);
}

/* Hide footer */
footer {
    display: none !important;
}

/* Responsive */
@media (max-width: 768px) {
    .admin-sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s ease;
    }

    .admin-sidebar.mobile-open {
        transform: translateX(0);
    }

    .admin-main {
        margin-left: 0;
    }

    .stats-grid {
        grid-template-columns: 1fr;
    }

    .content-area {
        padding: 20px;
    }

    .top-navbar {
        padding: 16px 20px;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- Sidebar -->
<div class="admin-sidebar" id="adminSidebar">
    <div class="sidebar-header">
        <h3>ü©∏ LifeLink Nepal</h3>
        <p>Super Admin Panel</p>
    </div>
    
    <div class="sidebar-menu">
        <a href="#dashboard" class="menu-item active" data-section="dashboard">
            <i class="bi bi-speedometer2"></i>
            <span>Dashboard</span>
        </a>
        <a href="#requests" class="menu-item" data-section="requests">
            <i class="bi bi-bell-fill"></i>
            <span>Blood Requests</span>
            <span class="menu-badge" id="requestCount">0</span>
        </a>
        <a href="#donors" class="menu-item" data-section="donors">
            <i class="bi bi-heart-pulse-fill"></i>
            <span>Donor Management</span>
        </a>
        <a href="#hospitals" class="menu-item" data-section="hospitals">
            <i class="bi bi-hospital-fill"></i>
            <span>Hospital Management</span>
        </a>
        <a href="#leaderboard" class="menu-item" data-section="leaderboard">
            <i class="bi bi-trophy-fill"></i>
            <span>Top Donors</span>
        </a>
        <a href="#matches" class="menu-item" data-section="matches">
            <i class="bi bi-link-45deg"></i>
            <span>Auto Matching</span>
        </a>
        <a href="#analytics" class="menu-item" data-section="analytics">
            <i class="bi bi-graph-up"></i>
            <span>Analytics</span>
        </a>
        <a href="#settings" class="menu-item" data-section="settings">
            <i class="bi bi-gear-fill"></i>
            <span>Settings</span>
        </a>
        <a href="{% url 'accounts:login_page' %}" class="menu-item" style="margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
            <i class="bi bi-box-arrow-right"></i>
            <span>Logout</span>
        </a>
    </div>
</div>

<!-- Main Content -->
<div class="admin-main">
    <!-- Top Navbar -->
    <div class="top-navbar">
        <div class="search-bar">
            <i class="bi bi-search"></i>
            <input type="text" placeholder="Search donors, hospitals, requests..." id="searchInput">
            <div class="search-results" id="searchResults"></div>
        </div>
        
        <div class="admin-profile">
            <div class="admin-avatar">{{ user.username|slice:":2"|upper|default:"SA" }}</div>
            <div>
                <h4 style="margin: 0; font-size: 15px; font-weight: 700;">{{ user.username|default:"Super Admin" }}</h4>
                <p style="margin: 0; font-size: 13px; color: var(--text-muted); font-weight: 500;">{{ user.email|default:"admin@lifelink.com" }}</p>
            </div>
        </div>
    </div>

    <!-- Content Area -->
    <div class="content-area" id="mainContent">
        <!-- Dashboard Section -->
        <div id="dashboardSection" class="content-section-wrapper">
            <div class="page-header">
                <h2>üìä Dashboard Overview</h2>
                <p>Monitor and manage all blood donation activities</p>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon donors">
                            <i class="bi bi-heart-pulse-fill"></i>
                        </div>
                    </div>
                    <div class="stat-content">
                        <h3 id="totalDonors">0</h3>
                        <p>Total Donors</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon hospitals">
                            <i class="bi bi-hospital-fill"></i>
                        </div>
                    </div>
                    <div class="stat-content">
                        <h3 id="totalHospitals">0</h3>
                        <p>Registered Hospitals</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon requests">
                            <i class="bi bi-bell-fill"></i>
                        </div>
                    </div>
                    <div class="stat-content">
                        <h3 id="activeRequests">0</h3>
                        <p>Active Requests</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon completed">
                            <i class="bi bi-check-circle-fill"></i>
                        </div>
                    </div>
                    <div class="stat-content">
                        <h3 id="completedRequests">0</h3>
                        <p>Completed</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon fulfilled">
                            <i class="bi bi-check2-circle"></i>
                        </div>
                    </div>
                    <div class="stat-content">
                        <h3 id="fulfilledRequests">0</h3>
                        <p>Fulfilled</p>
                    </div>
                </div>
            </div>

            <!-- Terminal Style Blood Requests -->
            <div class="content-section">
                <div class="section-header">
                    <h3>üíª Live Blood Request Terminal</h3>
                    <button class="btn-action btn-view" onclick="refreshTerminal()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
                <div class="terminal-requests" id="terminalRequests">
                    <div class="terminal-header">
                        <span>> LIFELINK BLOOD REQUEST MONITORING SYSTEM</span>
                        <span class="terminal-time" id="terminalTime"></span>
                    </div>
                    <div id="terminalContent">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p style="font-weight: 600; color: var(--text-muted);">Loading terminal...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Blood Requests Section -->
        <div id="requestsSection" class="content-section-wrapper" style="display: none;">
            <div class="page-header">
                <h2>üîî Blood Request Management</h2>
                <p>View and manage all emergency blood requests</p>
            </div>

            <div class="content-section">
                <div class="section-header">
                    <h3>All Blood Requests</h3>
                    <div class="filter-tabs">
                        <button class="filter-tab active" onclick="filterRequests('all')">All</button>
                        <button class="filter-tab" onclick="filterRequests('pending')">Pending</button>
                        <button class="filter-tab" onclick="filterRequests('matched')">Matched</button>
                        <button class="filter-tab" onclick="filterRequests('completed')">Completed</button>
                    </div>
                </div>
                <div id="allRequests">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p style="font-weight: 600; color: var(--text-muted);">Loading all requests...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Donors Section -->
        <div id="donorsSection" class="content-section-wrapper" style="display: none;">
            <div class="page-header">
                <h2>ü©∏ Donor Management</h2>
                <p>Manage all registered blood donors</p>
            </div>

            <div class="content-section">
                <div class="section-header">
                    <h3>All Donors</h3>
                    <div class="filter-tabs">
                        <button class="filter-tab active" onclick="filterDonors('all')">All Types</button>
                        <button class="filter-tab" onclick="filterDonors('A+')">A+</button>
                        <button class="filter-tab" onclick="filterDonors('A-')">A-</button>
                        <button class="filter-tab" onclick="filterDonors('B+')">B+</button>
                        <button class="filter-tab" onclick="filterDonors('B-')">B-</button>
                        <button class="filter-tab" onclick="filterDonors('O+')">O+</button>
                        <button class="filter-tab" onclick="filterDonors('O-')">O-</button>
                        <button class="filter-tab" onclick="filterDonors('AB+')">AB+</button>
                        <button class="filter-tab" onclick="filterDonors('AB-')">AB-</button>
                    </div>
                </div>
                <div id="donorsList">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p style="font-weight: 600; color: var(--text-muted);">Loading donors...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hospitals Section -->
        <div id="hospitalsSection" class="content-section-wrapper" style="display: none;">
            <div class="page-header">
                <h2>üè• Hospital Management</h2>
                <p>Manage all registered hospitals</p>
            </div>

            <div class="content-section">
                <div class="section-header">
                    <h3>All Hospitals</h3>
                </div>
                <div id="hospitalsList">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p style="font-weight: 600; color: var(--text-muted);">Loading hospitals...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Donors Leaderboard Section -->
        <div id="leaderboardSection" class="content-section-wrapper" style="display: none;">
            <div class="page-header">
                <h2>üèÜ Top Donors Leaderboard</h2>
                <p>Recognizing our heroes who save lives</p>
            </div>

            <div class="leaderboard-card">
                <div class="section-header">
                    <h3>üåü Hall of Fame</h3>
                </div>
                <div id="leaderboardList">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p style="font-weight: 600; color: var(--text-muted);">Loading leaderboard...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Auto Matching Section -->
        <div id="matchesSection" class="content-section-wrapper" style="display: none;">
            <div class="page-header">
                <h2>üîó Automatic Donor Matching</h2>
                <p>System automatically matches donors with blood requests</p>
            </div>

            <div class="content-section">
                <div class="section-header">
                    <h3>Auto-Matching Status</h3>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <label class="toggle-switch">
                            <input type="checkbox" id="autoMatchToggle" checked onchange="toggleAutoMatch(this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                        <span style="font-weight: 700; color: var(--text-dark);" id="autoMatchStatus">Auto-Matching Enabled</span>
                    </div>
                </div>
                <div id="matchesList">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p style="font-weight: 600; color: var(--text-muted);">Loading matching data...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Section -->
        <div id="analyticsSection" class="content-section-wrapper" style="display: none;">
            <div class="page-header">
                <h2>üìä Analytics & Reports</h2>
                <p>View detailed statistics and insights</p>
            </div>

            <!-- Blood Type Distribution -->
            <div class="content-section">
                <div class="section-header">
                    <h3>Blood Type Distribution</h3>
                </div>
                <div id="bloodTypeChart">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p style="font-weight: 600; color: var(--text-muted);">Loading analytics...</p>
                    </div>
                </div>
            </div>

            <!-- Request Fulfillment Analytics -->
            <div class="analytics-chart">
                <div class="section-header">
                    <h3>üìà Request Fulfillment Analytics</h3>
                </div>
                <div id="fulfillmentChart">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p style="font-weight: 600; color: var(--text-muted);">Loading analytics...</p>
                    </div>
                </div>
            </div>

            <!-- Monthly Trends -->
            <div class="analytics-chart">
                <div class="section-header">
                    <h3>üìÖ Monthly Trends</h3>
                </div>
                <div id="monthlyTrends">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p style="font-weight: 600; color: var(--text-muted);">Loading trends...</p>
                    </div>
                </div>
            </div>

            <!-- Request Status Overview -->
            <div class="content-section">
                <div class="section-header">
                    <h3>Request Status Overview</h3>
                </div>
                <div id="requestStatusChart">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p style="font-weight: 600; color: var(--text-muted);">Loading status data...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Section -->
        <div id="settingsSection" class="content-section-wrapper" style="display: none;">
            <div class="page-header">
                <h2>‚öôÔ∏è System Settings</h2>
                <p>Configure system preferences and notifications</p>
            </div>

            <!-- General Settings -->
            <div class="content-section">
                <div class="section-header">
                    <h3>General Settings</h3>
                </div>
                <div style="padding: 20px;">
                    <div style="margin-bottom: 24px;">
                        <label style="display: block; font-weight: 700; margin-bottom: 10px; color: var(--text-dark); font-size: 14px;">
                            <i class="bi bi-globe"></i> System Name
                        </label>
                        <input type="text" value="LifeLink Nepal" 
                               style="width: 100%; padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 10px; font-size: 15px;">
                    </div>

                    <div style="margin-bottom: 24px;">
                        <label style="display: block; font-weight: 700; margin-bottom: 10px; color: var(--text-dark); font-size: 14px;">
                            <i class="bi bi-envelope"></i> Admin Email
                        </label>
                        <input type="email" value="admin@lifelink.com" 
                               style="width: 100%; padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 10px; font-size: 15px;">
                    </div>

                    <div style="margin-bottom: 24px;">
                        <label style="display: block; font-weight: 700; margin-bottom: 10px; color: var(--text-dark); font-size: 14px;">
                            <i class="bi bi-telephone"></i> Emergency Contact
                        </label>
                        <input type="tel" value="+977-1-4444444" 
                               style="width: 100%; padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 10px; font-size: 15px;">
                    </div>
                </div>
            </div>

            <!-- Notification Settings -->
            <div class="content-section">
                <div class="section-header">
                    <h3>Notification Settings</h3>
                </div>
                <div style="padding: 20px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 20px; background: var(--light-bg); border-radius: 12px; margin-bottom: 16px; border: 2px solid var(--border-color);">
                        <div>
                            <strong style="display: block; color: var(--text-dark); font-size: 15px; font-weight: 700;">Email Notifications</strong>
                            <small style="color: var(--text-muted); font-weight: 500;">Send email alerts for new requests</small>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 20px; background: var(--light-bg); border-radius: 12px; margin-bottom: 16px; border: 2px solid var(--border-color);">
                        <div>
                            <strong style="display: block; color: var(--text-dark); font-size: 15px; font-weight: 700;">SMS Notifications</strong>
                            <small style="color: var(--text-muted); font-weight: 500;">Send SMS alerts to donors</small>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 20px; background: var(--light-bg); border-radius: 12px; margin-bottom: 16px; border: 2px solid var(--border-color);">
                        <div>
                            <strong style="display: block; color: var(--text-dark); font-size: 15px; font-weight: 700;">Automatic Donor Matching</strong>
                            <small style="color: var(--text-muted); font-weight: 500;">Automatically match and notify donors when requests are created</small>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="settingsAutoMatch" checked onchange="syncAutoMatch(this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 20px; background: var(--light-bg); border-radius: 12px; margin-bottom: 16px; border: 2px solid var(--border-color);">
                        <div>
                            <strong style="display: block; color: var(--text-dark); font-size: 15px; font-weight: 700;">Push Notifications</strong>
                            <small style="color: var(--text-muted); font-weight: 500;">Enable browser push notifications</small>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- System Information -->
            <div class="content-section">
                <div class="section-header">
                    <h3>System Information</h3>
                </div>
                <div style="padding: 20px;">
                    <table class="data-table">
                        <tbody>
                            <tr>
                                <td style="font-weight: 700;">Version</td>
                                <td>1.0.0</td>
                            </tr>
                            <tr>
                                <td style="font-weight: 700;">Last Updated</td>
                                <td>February 01, 2026</td>
                            </tr>
                            <tr>
                                <td style="font-weight: 700;">Database Status</td>
                                <td><span class="status-badge active">ONLINE</span></td>
                            </tr>
                            <tr>
                                <td style="font-weight: 700;">Total Users</td>
                                <td><strong id="settingsTotalUsers" style="font-size: 16px;">0</strong></td>
                            </tr>
                            <tr>
                                <td style="font-weight: 700;">Storage Used</td>
                                <td>2.4 GB / 100 GB</td>
                            </tr>
                            <tr>
                                <td style="font-weight: 700;">API Status</td>
                                <td><span class="status-badge active">OPERATIONAL</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="content-section">
                <div style="display: flex; gap: 14px; padding: 24px; flex-wrap: wrap;">
                    <button class="btn-action btn-approve" onclick="saveSettings()">
                        <i class="bi bi-check-circle-fill"></i> Save Settings
                    </button>
                    <button class="btn-action btn-view" onclick="exportData()">
                        <i class="bi bi-download"></i> Export Data
                    </button>
                    <button class="btn-action btn-notify" onclick="testNotifications()">
                        <i class="bi bi-bell-fill"></i> Test Notifications
                    </button>
                    <button class="btn-action btn-reject" onclick="clearCache()">
                        <i class="bi bi-trash-fill"></i> Clear Cache
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables
let allDonors = [];
let allRequests = [];
let allHospitals = [];
let donationHistory = [];
let autoMatchEnabled = true;
let currentRequestFilter = 'all';
let currentDonorFilter = 'all';

// API Configuration
const token = localStorage.getItem('accessToken');
const API_URL = window.location.origin;

// Get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// API Request Helper
async function makeApiRequest(url, options = {}) {
    const headers = {
        'Content-Type': 'application/json',
        ...options.headers
    };
    
    if (options.method && options.method !== 'GET' && csrftoken) {
        headers['X-CSRFToken'] = csrftoken;
    }
    
    if (token) {
        headers['Authorization'] = `Bearer ${token}`;
    }
    
    try {
        const response = await fetch(url, {
            ...options,
            headers,
            credentials: 'include'
        });
        
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            return response;
        } else {
            throw new Error('Server returned non-JSON response');
        }
    } catch (error) {
        console.error('API Request Error:', error);
        throw error;
    }
}

// Navigation
document.querySelectorAll('.menu-item[data-section]').forEach(item => {
    item.addEventListener('click', function(e) {
        e.preventDefault();
        const section = this.dataset.section;
        showSection(section);
        
        document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
        this.classList.add('active');
    });
});

function showSection(section) {
    document.querySelectorAll('.content-section-wrapper').forEach(s => s.style.display = 'none');
    
    const sectionMap = {
        'dashboard': 'dashboardSection',
        'requests': 'requestsSection',
        'donors': 'donorsSection',
        'hospitals': 'hospitalsSection',
        'leaderboard': 'leaderboardSection',
        'matches': 'matchesSection',
        'analytics': 'analyticsSection',
        'settings': 'settingsSection'
    };
    
    const sectionId = sectionMap[section];
    if (sectionId) {
        document.getElementById(sectionId).style.display = 'block';
        
        if (section === 'requests') loadAllRequests();
        if (section === 'donors') loadAllDonors();
        if (section === 'hospitals') loadAllHospitals();
        if (section === 'leaderboard') loadLeaderboard();
        if (section === 'matches') loadMatches();
        if (section === 'analytics') loadAnalytics();
        if (section === 'settings') loadSettings();
    }
}

// Update Terminal Time
function updateTerminalTime() {
    const now = new Date();
    const timeStr = now.toLocaleString('en-US', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
    });
    const terminalTimeEl = document.getElementById('terminalTime');
    if (terminalTimeEl) {
        terminalTimeEl.textContent = `[${timeStr}]`;
    }
}

setInterval(updateTerminalTime, 1000);
updateTerminalTime();

// Load Dashboard Stats
async function loadDashboardStats() {
    try {
        const donorsRes = await makeApiRequest(`${API_URL}/api/donors/`);
        allDonors = await donorsRes.json();
        document.getElementById('totalDonors').textContent = allDonors.length;

        const hospitalsRes = await makeApiRequest(`${API_URL}/api/hospitals/`);
        allHospitals = await hospitalsRes.json();
        document.getElementById('totalHospitals').textContent = allHospitals.length;

        const requestsRes = await makeApiRequest(`${API_URL}/api/blood-requests/`);
        allRequests = await requestsRes.json();
        
        const activeReqs = allRequests.filter(r => r.status === 'pending' || r.status === 'matched');
        const completedReqs = allRequests.filter(r => r.status === 'completed');
        const fulfilledReqs = allRequests.filter(r => r.status === 'fulfilled');
        
        document.getElementById('activeRequests').textContent = activeReqs.length;
        document.getElementById('completedRequests').textContent = completedReqs.length;
        document.getElementById('fulfilledRequests').textContent = fulfilledReqs.length;
        document.getElementById('requestCount').textContent = activeReqs.length;

        loadTerminalRequests();

    } catch (error) {
        console.error('Error loading stats:', error);
        alert('‚ö†Ô∏è Error loading dashboard data. Please refresh the page.');
    }
}

// Load Terminal Style Requests
function loadTerminalRequests() {
    const container = document.getElementById('terminalContent');
    
    if (allRequests.length === 0) {
        container.innerHTML = `
            <div class="terminal-line">
                <span class="terminal-label">[SYSTEM]</span>
                <span class="terminal-value"> No blood requests in queue</span>
            </div>
        `;
        return;
    }

    const sortedRequests = allRequests
        .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
        .slice(0, 10);

    container.innerHTML = sortedRequests.map((req, index) => {
        const urgencyClass = req.urgency === 'critical' ? 'urgent' : '';
        const statusClass = req.status === 'fulfilled' ? 'fulfilled' : '';
        const statusText = req.status === 'fulfilled' ? 'FULFILLED' : req.status.toUpperCase();
        
        return `
            <div class="terminal-request ${urgencyClass} ${statusClass}">
                <div class="terminal-line">
                    <span class="terminal-label">[REQUEST #${req.id}]</span>
                    <span class="terminal-value"> ${new Date(req.created_at).toLocaleString()}</span>
                </div>
                <div class="terminal-line">
                    <span class="terminal-label">HOSPITAL:</span>
                    <span class="terminal-value"> ${req.hospital_name || 'Unknown'}</span>
                </div>
                <div class="terminal-line">
                    <span class="terminal-label">BLOOD TYPE:</span>
                    <span class="terminal-value"> ${req.blood_type}</span>
                    <span class="terminal-label"> | UNITS:</span>
                    <span class="terminal-value"> ${req.units_needed}</span>
                </div>
                <div class="terminal-line">
                    <span class="terminal-label">URGENCY:</span>
                    <span class="${req.urgency === 'critical' ? 'terminal-urgent' : 'terminal-value'}"> ${req.urgency?.toUpperCase() || 'MEDIUM'}</span>
                </div>
                <div class="terminal-line">
                    <span class="terminal-label">STATUS:</span>
                    <span class="${req.status === 'fulfilled' ? 'terminal-fulfilled' : 'terminal-value'}"> ${statusText}</span>
                </div>
                ${req.status !== 'fulfilled' ? `
                <div class="terminal-line">
                    <span class="terminal-urgent">>> WAITING FOR DONORS... ${Array(10 - index).fill('‚ñà').join('')}${Array(index).fill('‚ñë').join('')}</span>
                </div>
                ` : `
                <div class="terminal-line">
                    <span class="terminal-fulfilled">‚úì REQUEST SUCCESSFULLY FULFILLED</span>
                </div>
                `}
            </div>
        `;
    }).join('');
}

function refreshTerminal() {
    loadDashboardStats();
}

// Filter Requests
function filterRequests(filter) {
    currentRequestFilter = filter;
    document.querySelectorAll('#requestsSection .filter-tab').forEach(tab => {
        tab.classList.toggle('active', tab.textContent.toLowerCase().includes(filter));
    });
    loadAllRequests();
}

// Load All Requests
async function loadAllRequests() {
    try {
        if (allRequests.length === 0) {
            const response = await makeApiRequest(`${API_URL}/api/blood-requests/`);
            allRequests = await response.json();
        }
        
        const container = document.getElementById('allRequests');
        
        let filteredRequests = allRequests;
        if (currentRequestFilter !== 'all') {
            filteredRequests = allRequests.filter(r => r.status === currentRequestFilter);
        }
        
        if (filteredRequests.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="bi bi-inbox"></i>
                    <h4>No Requests Found</h4>
                    <p>There are no ${currentRequestFilter !== 'all' ? currentRequestFilter : ''} blood requests to display</p>
                </div>
            `;
            return;
        }

        const sortedRequests = filteredRequests.sort((a, b) => 
            new Date(b.created_at) - new Date(a.created_at)
        );

        const html = `
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width: 5%;">ID</th>
                        <th style="width: 18%;">Hospital</th>
                        <th style="width: 10%;">Blood Type</th>
                        <th style="width: 10%;">Units</th>
                        <th style="width: 10%;">Urgency</th>
                        <th style="width: 10%;">Status</th>
                        <th style="width: 10%;">Eligible</th>
                        <th style="width: 12%;">Date</th>
                        <th style="width: 15%;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${sortedRequests.map(req => {
                        const eligibleCount = allDonors.filter(d => d.blood_type === req.blood_type).length;
                        return `
                        <tr>
                            <td><strong>#${req.id}</strong></td>
                            <td>
                                <div class="hospital-info">
                                    <div class="hospital-avatar">${req.hospital_name?.charAt(0) || 'H'}</div>
                                    <div class="info-text">
                                        <h4>${req.hospital_name || 'Hospital'}</h4>
                                        <p>${req.contact_number || 'N/A'}</p>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="blood-type ${req.blood_type?.includes('-') ? 'negative' : 'positive'}">
                                    ${req.blood_type}
                                </span>
                            </td>
                            <td><strong>${req.units_needed}</strong></td>
                            <td><span class="status-badge ${(req.urgency || 'medium').toLowerCase()}">${(req.urgency || 'Medium').toUpperCase()}</span></td>
                            <td><span class="status-badge ${req.status}">${req.status?.toUpperCase()}</span></td>
                            <td><strong>${eligibleCount}</strong></td>
                            <td>${new Date(req.created_at).toLocaleDateString()}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-action btn-notify" onclick="notifyDonors(${req.id}, '${req.blood_type}')" id="notifyBtn${req.id}">
                                        <i class="bi bi-bell-fill"></i> Notify
                                    </button>
                                    <button class="btn-action btn-view" onclick="viewRequestDetails(${req.id})">
                                        <i class="bi bi-eye-fill"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `}).join('')}
                </tbody>
            </table>
        `;
        
        container.innerHTML = html;

    } catch (error) {
        console.error('Error loading requests:', error);
        document.getElementById('allRequests').innerHTML = `
            <div class="empty-state">
                <i class="bi bi-exclamation-triangle"></i>
                <h4>Error Loading Requests</h4>
                <p>${error.message || 'Please try again later'}</p>
            </div>
        `;
    }
}

// Filter Donors
function filterDonors(bloodType) {
    currentDonorFilter = bloodType;
    document.querySelectorAll('#donorsSection .filter-tab').forEach(tab => {
        tab.classList.toggle('active', tab.textContent.trim() === bloodType || (bloodType === 'all' && tab.textContent.includes('All')));
    });
    loadAllDonors();
}

// Load All Donors
async function loadAllDonors() {
    try {
        if (allDonors.length === 0) {
            const response = await makeApiRequest(`${API_URL}/api/donors/`);
            allDonors = await response.json();
        }
        
        const container = document.getElementById('donorsList');
        
        let filteredDonors = allDonors;
        if (currentDonorFilter !== 'all') {
            filteredDonors = allDonors.filter(d => d.blood_type === currentDonorFilter);
        }
        
        if (filteredDonors.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="bi bi-inbox"></i>
                    <h4>No Donors Found</h4>
                    <p>There are no ${currentDonorFilter !== 'all' ? currentDonorFilter : ''} donors registered yet</p>
                </div>
            `;
            return;
        }

        const html = `
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width: 25%;">Donor</th>
                        <th style="width: 12%;">Blood Type</th>
                        <th style="width: 10%;">Age</th>
                        <th style="width: 15%;">Phone</th>
                        <th style="width: 20%;">Address</th>
                        <th style="width: 10%;">Status</th>
                        <th style="width: 8%;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${filteredDonors.map(donor => `
                        <tr>
                            <td>
                                <div class="donor-info">
                                    <div class="donor-avatar">${donor.full_name?.charAt(0) || 'D'}</div>
                                    <div class="info-text">
                                        <h4>${donor.full_name || 'Donor'}</h4>
                                        <p>${donor.email || 'N/A'}</p>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="blood-type ${donor.blood_type?.includes('-') ? 'negative' : 'positive'}">
                                    ${donor.blood_type}
                                </span>
                            </td>
                            <td>${donor.age} years</td>
                            <td>${donor.phone || 'N/A'}</td>
                            <td>${donor.address || 'N/A'}</td>
                            <td><span class="status-badge active">ACTIVE</span></td>
                            <td>
                                <button class="btn-action btn-view" onclick="viewDonorDetails(${donor.id})">
                                    <i class="bi bi-eye-fill"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        
        container.innerHTML = html;

    } catch (error) {
        console.error('Error loading donors:', error);
        document.getElementById('donorsList').innerHTML = `
            <div class="empty-state">
                <i class="bi bi-exclamation-triangle"></i>
                <h4>Error Loading Donors</h4>
                <p>${error.message || 'Please try again later'}</p>
            </div>
        `;
    }
}

// Load All Hospitals
async function loadAllHospitals() {
    try {
        if (allHospitals.length === 0) {
            const response = await makeApiRequest(`${API_URL}/api/hospitals/`);
            allHospitals = await response.json();
        }
        
        const container = document.getElementById('hospitalsList');
        
        if (allHospitals.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="bi bi-inbox"></i>
                    <h4>No Hospitals Found</h4>
                    <p>There are no registered hospitals yet</p>
                </div>
            `;
            return;
        }

        const html = `
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width: 30%;">Hospital</th>
                        <th style="width: 15%;">Contact</th>
                        <th style="width: 30%;">Address</th>
                        <th style="width: 12%;">Requests</th>
                        <th style="width: 10%;">Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${allHospitals.map(hospital => {
                        const hospitalRequests = allRequests.filter(r => r.hospital === hospital.id || r.hospital_name === hospital.hospital_name);
                        return `
                        <tr>
                            <td>
                                <div class="hospital-info">
                                    <div class="hospital-avatar">${hospital.hospital_name?.charAt(0) || 'H'}</div>
                                    <div class="info-text">
                                        <h4>${hospital.hospital_name || 'Hospital'}</h4>
                                        <p>${hospital.email || 'N/A'}</p>
                                    </div>
                                </div>
                            </td>
                            <td>${hospital.phone || 'N/A'}</td>
                            <td>${hospital.address || 'N/A'}</td>
                            <td><strong>${hospitalRequests.length}</strong> requests</td>
                            <td><span class="status-badge active">ACTIVE</span></td>
                            <td>
                                <button class="btn-action btn-view" onclick="viewHospitalDetails(${hospital.id})">
                                    <i class="bi bi-eye-fill"></i>
                                </button>
                            </td>
                        </tr>
                    `}).join('')}
                </tbody>
            </table>
        `;
        
        container.innerHTML = html;

    } catch (error) {
        console.error('Error loading hospitals:', error);
        document.getElementById('hospitalsList').innerHTML = `
            <div class="empty-state">
                <i class="bi bi-exclamation-triangle"></i>
                <h4>Error Loading Hospitals</h4>
                <p>${error.message || 'Please try again later'}</p>
            </div>
        `;
    }
}

// Load Leaderboard
async function loadLeaderboard() {
    try {
        if (allDonors.length === 0) {
            const donorsRes = await makeApiRequest(`${API_URL}/api/donors/`);
            allDonors = await donorsRes.json();
        }

        // Simulate donation counts (replace with actual donation history data)
        const donorsWithDonations = allDonors.map(donor => ({
            ...donor,
            donation_count: Math.floor(Math.random() * 15) + 1,
            stars: Math.min(5, Math.floor((Math.random() * 15 + 1) / 3))
        })).sort((a, b) => b.donation_count - a.donation_count);

        const container = document.getElementById('leaderboardList');
        
        if (donorsWithDonations.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="bi bi-trophy"></i>
                    <h4>No Donors Yet</h4>
                    <p>The leaderboard will appear when donors start donating blood</p>
                </div>
            `;
            return;
        }

        container.innerHTML = donorsWithDonations.slice(0, 20).map((donor, index) => {
            const rank = index + 1;
            const rankClass = rank === 1 ? 'rank-1' : rank === 2 ? 'rank-2' : rank === 3 ? 'rank-3' : 'rank-other';
            const stars = Array(donor.stars).fill('<i class="bi bi-star-fill star"></i>').join('');
            
            return `
                <div class="leaderboard-item ${rankClass}">
                    <div class="rank-badge ${rankClass}">
                        ${rank <= 3 ? (rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : 'ü•â') : `#${rank}`}
                    </div>
                    <div class="donor-info" style="flex: 1;">
                        <div class="donor-avatar">${donor.full_name?.charAt(0) || 'D'}</div>
                        <div class="info-text">
                            <h4>${donor.full_name || 'Anonymous Donor'}</h4>
                            <p>${donor.blood_type} ‚Ä¢ ${donor.address || 'Location not set'}</p>
                            <div class="donor-stars">${stars}</div>
                        </div>
                    </div>
                    <div class="donation-count">
                        <i class="bi bi-droplet-fill"></i> ${donor.donation_count} donation${donor.donation_count !== 1 ? 's' : ''}
                    </div>
                </div>
            `;
        }).join('');

    } catch (error) {
        console.error('Error loading leaderboard:', error);
        document.getElementById('leaderboardList').innerHTML = `
            <div class="empty-state">
                <i class="bi bi-exclamation-triangle"></i>
                <h4>Error Loading Leaderboard</h4>
                <p>${error.message || 'Please try again later'}</p>
            </div>
        `;
    }
}

// Load Matches
async function loadMatches() {
    try {
        if (allRequests.length === 0) {
            const requestsResponse = await makeApiRequest(`${API_URL}/api/blood-requests/`);
            allRequests = await requestsResponse.json();
        }
        
        if (allDonors.length === 0) {
            const donorsResponse = await makeApiRequest(`${API_URL}/api/donors/`);
            allDonors = await donorsResponse.json();
        }
        
        const container = document.getElementById('matchesList');
        const activeRequests = allRequests.filter(r => r.status === 'pending' || r.status === 'matched');
        
        if (activeRequests.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="bi bi-check-circle"></i>
                    <h4>No Active Requests</h4>
                    <p>All blood requests have been fulfilled or there are no pending requests</p>
                </div>
            `;
            return;
        }

        const html = `
            <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 20px; border-radius: 12px; margin-bottom: 24px; border: 2px solid #93c5fd;">
                <h4 style="margin: 0 0 8px 0; font-weight: 800; color: #1e40af;"><i class="bi bi-info-circle-fill"></i> Auto-Matching Information</h4>
                <p style="margin: 0; color: #1e3a8a; font-weight: 500;">When auto-matching is ${autoMatchEnabled ? 'enabled' : 'disabled'}, the system ${autoMatchEnabled ? 'automatically notifies' : 'does not automatically notify'} eligible donors when new blood requests are created. You can manually notify donors using the buttons below.</p>
            </div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width: 8%;">ID</th>
                        <th style="width: 22%;">Hospital</th>
                        <th style="width: 12%;">Blood Type</th>
                        <th style="width: 10%;">Units</th>
                        <th style="width: 12%;">Matching</th>
                        <th style="width: 12%;">Urgency</th>
                        <th style="width: 24%;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${activeRequests.map(req => {
                        const matchingDonors = allDonors.filter(d => d.blood_type === req.blood_type);
                        return `
                            <tr>
                                <td><strong>#${req.id}</strong></td>
                                <td>
                                    <div class="hospital-info">
                                        <div class="hospital-avatar">${req.hospital_name?.charAt(0) || 'H'}</div>
                                        <div class="info-text">
                                            <h4>${req.hospital_name || 'Hospital'}</h4>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="blood-type ${req.blood_type?.includes('-') ? 'negative' : 'positive'}">
                                        ${req.blood_type}
                                    </span>
                                </td>
                                <td><strong>${req.units_needed}</strong></td>
                                <td><strong style="color: var(--success); font-size: 16px;">${matchingDonors.length}</strong> eligible</td>
                                <td><span class="status-badge ${(req.urgency || 'medium').toLowerCase()}">${(req.urgency || 'Medium').toUpperCase()}</span></td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn-action btn-notify" onclick="notifyDonors(${req.id}, '${req.blood_type}')" id="notifyBtn${req.id}">
                                            <i class="bi bi-bell-fill"></i> Notify All
                                        </button>
                                        <button class="btn-action btn-view" onclick="viewMatchingDonors(${req.id}, '${req.blood_type}')">
                                            <i class="bi bi-people-fill"></i> View
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        `;
        
        container.innerHTML = html;

    } catch (error) {
        console.error('Error loading matches:', error);
        document.getElementById('matchesList').innerHTML = `
            <div class="empty-state">
                <i class="bi bi-exclamation-triangle"></i>
                <h4>Error Loading Matching Data</h4>
                <p>${error.message || 'Please try again later'}</p>
            </div>
        `;
    }
}

// Load Analytics
async function loadAnalytics() {
    try {
        if (allDonors.length === 0) {
            const donorsResponse = await makeApiRequest(`${API_URL}/api/donors/`);
            allDonors = await donorsResponse.json();
        }

        if (allRequests.length === 0) {
            const requestsResponse = await makeApiRequest(`${API_URL}/api/blood-requests/`);
            allRequests = await requestsResponse.json();
        }

        // Blood Type Distribution
        const bloodTypes = ['A+', 'A-', 'B+', 'B-', 'O+', 'O-', 'AB+', 'AB-'];
        const bloodTypeChart = document.getElementById('bloodTypeChart');
        
        const bloodTypeDistribution = bloodTypes.map(type => {
            const count = allDonors.filter(d => d.blood_type === type).length;
            return { type, count };
        });

        bloodTypeChart.innerHTML = `
            <div class="blood-chart">
                ${bloodTypeDistribution.map(item => `
                    <div class="blood-chart-item">
                        <span class="blood-type ${item.type.includes('-') ? 'negative' : 'positive'}">
                            ${item.type}
                        </span>
                        <span class="count">${item.count}</span>
                        <span class="label">donors</span>
                    </div>
                `).join('')}
            </div>
        `;

        // Request Fulfillment Analytics
        const totalRequests = allRequests.length;
        const pending = allRequests.filter(r => r.status === 'pending').length;
        const matched = allRequests.filter(r => r.status === 'matched').length;
        const completed = allRequests.filter(r => r.status === 'completed').length;
        const fulfilled = allRequests.filter(r => r.status === 'fulfilled').length;

        const fulfillmentContainer = document.getElementById('fulfillmentChart');
        
        fulfillmentContainer.innerHTML = `
            <div class="chart-bar">
                <div class="chart-label">Pending</div>
                <div class="chart-bar-container">
                    <div class="chart-bar-fill" style="width: ${totalRequests > 0 ? (pending / totalRequests * 100) : 0}%">
                        ${pending}
                    </div>
                </div>
            </div>
            <div class="chart-bar">
                <div class="chart-label">Matched</div>
                <div class="chart-bar-container">
                    <div class="chart-bar-fill" style="width: ${totalRequests > 0 ? (matched / totalRequests * 100) : 0}%; background: linear-gradient(90deg, #0ea5e9, #06b6d4);">
                        ${matched}
                    </div>
                </div>
            </div>
            <div class="chart-bar">
                <div class="chart-label">Completed</div>
                <div class="chart-bar-container">
                    <div class="chart-bar-fill" style="width: ${totalRequests > 0 ? (completed / totalRequests * 100) : 0}%; background: linear-gradient(90deg, #f59e0b, #d97706);">
                        ${completed}
                    </div>
                </div>
            </div>
            <div class="chart-bar">
                <div class="chart-label">Fulfilled ‚úì</div>
                <div class="chart-bar-container">
                    <div class="chart-bar-fill fulfilled" style="width: ${totalRequests > 0 ? (fulfilled / totalRequests * 100) : 0}%">
                        ${fulfilled}
                    </div>
                </div>
            </div>
        `;

        // Monthly Trends
        const monthlyContainer = document.getElementById('monthlyTrends');
        const thisMonth = new Date().getMonth();
        const thisMonthRequests = allRequests.filter(r => {
            const reqMonth = new Date(r.created_at).getMonth();
            return reqMonth === thisMonth;
        });

        const thisMonthFulfilled = thisMonthRequests.filter(r => r.status === 'fulfilled').length;
        const fulfillmentRate = thisMonthRequests.length > 0 
            ? ((thisMonthFulfilled / thisMonthRequests.length) * 100).toFixed(1)
            : 0;

        monthlyContainer.innerHTML = `
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-content">
                        <h3>${thisMonthRequests.length}</h3>
                        <p>This Month's Requests</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-content">
                        <h3>${thisMonthFulfilled}</h3>
                        <p>Fulfilled This Month</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-content">
                        <h3>${fulfillmentRate}%</h3>
                        <p>Fulfillment Rate</p>
                    </div>
                </div>
            </div>
        `;

        // Request Status Overview
        const requestStatusChart = document.getElementById('requestStatusChart');
        const statusCounts = {
            pending: allRequests.filter(r => r.status === 'pending').length,
            matched: allRequests.filter(r => r.status === 'matched').length,
            completed: allRequests.filter(r => r.status === 'completed').length,
            fulfilled: allRequests.filter(r => r.status === 'fulfilled').length
        };

        requestStatusChart.innerHTML = `
            <div class="blood-chart">
                <div class="blood-chart-item" style="border-color: var(--warning);">
                    <span style="font-size: 20px; color: var(--warning); margin-bottom: 12px; display: block;">‚è≥</span>
                    <span class="count">${statusCounts.pending}</span>
                    <span class="label">Pending</span>
                </div>
                <div class="blood-chart-item" style="border-color: var(--info);">
                    <span style="font-size: 20px; color: var(--info); margin-bottom: 12px; display: block;">üîó</span>
                    <span class="count">${statusCounts.matched}</span>
                    <span class="label">Matched</span>
                </div>
                <div class="blood-chart-item" style="border-color: var(--success);">
                    <span style="font-size: 20px; color: var(--success); margin-bottom: 12px; display: block;">‚úÖ</span>
                    <span class="count">${statusCounts.completed}</span>
                    <span class="label">Completed</span>
                </div>
                <div class="blood-chart-item" style="border-color: var(--primary-blue);">
                    <span style="font-size: 20px; color: var(--primary-blue); margin-bottom: 12px; display: block;">üéâ</span>
                    <span class="count">${statusCounts.fulfilled}</span>
                    <span class="label">Fulfilled</span>
                </div>
            </div>
        `;

    } catch (error) {
        console.error('Error loading analytics:', error);
        const containers = ['bloodTypeChart', 'fulfillmentChart', 'monthlyTrends', 'requestStatusChart'];
        containers.forEach(containerId => {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-exclamation-triangle"></i>
                        <h4>Error Loading Analytics</h4>
                        <p>${error.message || 'Please try again later'}</p>
                    </div>
                `;
            }
        });
    }
}

// Load Settings
function loadSettings() {
    const totalUsers = allDonors.length + allHospitals.length;
    document.getElementById('settingsTotalUsers').textContent = totalUsers;
    
    // Sync auto-match toggle
    const settingsToggle = document.getElementById('settingsAutoMatch');
    if (settingsToggle) {
        settingsToggle.checked = autoMatchEnabled;
    }
}

// Toggle Auto Match
function toggleAutoMatch(enabled) {
    autoMatchEnabled = enabled;
    document.getElementById('autoMatchStatus').textContent = enabled ? 'Auto-Matching Enabled' : 'Auto-Matching Disabled';
    
    // Sync with settings page
    const settingsToggle = document.getElementById('settingsAutoMatch');
    if (settingsToggle) {
        settingsToggle.checked = enabled;
    }
    
    // Show notification
    const message = enabled 
        ? '‚úÖ Auto-matching enabled! Donors will be automatically notified for new requests.'
        : '‚ö†Ô∏è Auto-matching disabled. You will need to manually notify donors.';
    
    alert(message);
}

// Sync Auto Match from Settings
function syncAutoMatch(enabled) {
    autoMatchEnabled = enabled;
    const matchesToggle = document.getElementById('autoMatchToggle');
    if (matchesToggle) {
        matchesToggle.checked = enabled;
    }
    document.getElementById('autoMatchStatus').textContent = enabled ? 'Auto-Matching Enabled' : 'Auto-Matching Disabled';
}

// Notify Donors
async function notifyDonors(requestId, bloodType) {
    const button = document.getElementById(`notifyBtn${requestId}`);
    if (!button) return;
    
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="bi bi-hourglass-split"></i> Sending...';
    
    try {
        const matchingDonors = allDonors.filter(d => d.blood_type === bloodType);
        
        if (matchingDonors.length === 0) {
            alert(`‚ö†Ô∏è No eligible donors found with blood type ${bloodType}`);
            return;
        }

        // Simulate notification sending (replace with actual API call)
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        button.innerHTML = '<i class="bi bi-check-circle-fill"></i> Notified!';
        button.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
        
        alert(`‚úÖ Successfully notified ${matchingDonors.length} eligible donor(s) with blood type ${bloodType}!`);
        
        setTimeout(() => {
            button.innerHTML = originalText;
            button.disabled = false;
            button.style.background = '';
        }, 3000);
        
    } catch (error) {
        console.error('Error notifying donors:', error);
        alert('‚ùå Error sending notifications. Please try again.');
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

// View Functions
function viewRequestDetails(requestId) {
    const request = allRequests.find(r => r.id === requestId);
    if (!request) {
        alert('‚ùå Request not found');
        return;
    }
    
    const matchingDonors = allDonors.filter(d => d.blood_type === request.blood_type);
    
    alert(`
üìã REQUEST DETAILS

ID: #${request.id}
Hospital: ${request.hospital_name || 'N/A'}
Blood Type: ${request.blood_type}
Units Needed: ${request.units_needed}
Urgency: ${(request.urgency || 'Medium').toUpperCase()}
Status: ${request.status?.toUpperCase()}
Contact: ${request.contact_number || 'N/A'}
Matching Donors: ${matchingDonors.length}
Created: ${new Date(request.created_at).toLocaleString()}
${request.patient_name ? `\nPatient: ${request.patient_name}` : ''}
${request.reason ? `\nReason: ${request.reason}` : ''}
    `.trim());
}

function viewDonorDetails(donorId) {
    const donor = allDonors.find(d => d.id === donorId);
    if (!donor) {
        alert('‚ùå Donor not found');
        return;
    }
    
    alert(`
üë§ DONOR DETAILS

Name: ${donor.full_name || 'N/A'}
Blood Type: ${donor.blood_type}
Age: ${donor.age} years
Phone: ${donor.phone || 'N/A'}
Email: ${donor.email || 'N/A'}
Address: ${donor.address || 'N/A'}
Status: ACTIVE
Last Donation: ${donor.last_donation_date || 'Never'}
Total Donations: ${Math.floor(Math.random() * 10) + 1}
    `.trim());
}

function viewHospitalDetails(hospitalId) {
    const hospital = allHospitals.find(h => h.id === hospitalId);
    if (!hospital) {
        alert('‚ùå Hospital not found');
        return;
    }
    
    const hospitalRequests = allRequests.filter(r => r.hospital === hospital.id || r.hospital_name === hospital.hospital_name);
    
    alert(`
üè• HOSPITAL DETAILS

Name: ${hospital.hospital_name || 'N/A'}
Email: ${hospital.email || 'N/A'}
Phone: ${hospital.phone || 'N/A'}
Address: ${hospital.address || 'N/A'}
Total Requests: ${hospitalRequests.length}
Active Requests: ${hospitalRequests.filter(r => r.status === 'pending' || r.status === 'matched').length}
Completed: ${hospitalRequests.filter(r => r.status === 'completed' || r.status === 'fulfilled').length}
Status: ACTIVE
    `.trim());
}

function viewMatchingDonors(requestId, bloodType) {
    const matchingDonors = allDonors.filter(d => d.blood_type === bloodType);
    
    if (matchingDonors.length === 0) {
        alert(`‚ö†Ô∏è No matching donors found with blood type ${bloodType}`);
        return;
    }
    
    const donorsList = matchingDonors
        .slice(0, 10)
        .map((d, i) => `${i + 1}. ${d.full_name || 'Anonymous'} - ${d.phone || 'N/A'} - ${d.address || 'N/A'}`)
        .join('\n');
    
    alert(`
ü©∏ MATCHING DONORS FOR REQUEST #${requestId}

Blood Type: ${bloodType}
Total Matching Donors: ${matchingDonors.length}

Top ${Math.min(10, matchingDonors.length)} Donors:
${donorsList}

${matchingDonors.length > 10 ? `\n... and ${matchingDonors.length - 10} more` : ''}
    `.trim());
}

// Settings Functions
function saveSettings() {
    alert('‚úÖ Settings saved successfully!');
}

function exportData() {
    const data = {
        donors: allDonors,
        hospitals: allHospitals,
        requests: allRequests,
        exportDate: new Date().toISOString()
    };
    
    const dataStr = JSON.stringify(data, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    
    const link = document.createElement('a');
    link.href = url;
    link.download = `lifelink-data-${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    
    URL.revokeObjectURL(url);
    alert('‚úÖ Data exported successfully!');
}

function testNotifications() {
    alert('üîî Test notification sent! Check your email and SMS.');
}

function clearCache() {
    if (confirm('‚ö†Ô∏è Are you sure you want to clear the cache? This will refresh all data.')) {
        allDonors = [];
        allRequests = [];
        allHospitals = [];
        loadDashboardStats();
        alert('‚úÖ Cache cleared successfully!');
    }
}

// Search Functionality
let searchTimeout;
const searchInput = document.getElementById('searchInput');
const searchResults = document.getElementById('searchResults');

searchInput.addEventListener('input', function(e) {
    clearTimeout(searchTimeout);
    const query = e.target.value.trim().toLowerCase();
    
    if (query.length < 2) {
        searchResults.classList.remove('active');
        return;
    }
    
    searchTimeout = setTimeout(() => {
        performSearch(query);
    }, 300);
});

function performSearch(query) {
    const results = [];
    
    // Search donors
    allDonors.forEach(donor => {
        if (donor.full_name?.toLowerCase().includes(query) || 
            donor.email?.toLowerCase().includes(query) ||
            donor.blood_type?.toLowerCase().includes(query)) {
            results.push({
                type: 'Donor',
                title: donor.full_name || 'Donor',
                subtitle: `${donor.blood_type} ‚Ä¢ ${donor.phone || 'N/A'}`,
                action: () => viewDonorDetails(donor.id)
            });
        }
    });
    
    // Search hospitals
    allHospitals.forEach(hospital => {
        if (hospital.hospital_name?.toLowerCase().includes(query) || 
            hospital.address?.toLowerCase().includes(query)) {
            results.push({
                type: 'Hospital',
                title: hospital.hospital_name || 'Hospital',
                subtitle: hospital.address || 'N/A',
                action: () => viewHospitalDetails(hospital.id)
            });
        }
    });
    
    // Search requests
    allRequests.forEach(request => {
        if (request.hospital_name?.toLowerCase().includes(query) || 
            request.blood_type?.toLowerCase().includes(query) ||
            request.id.toString().includes(query)) {
            results.push({
                type: 'Request',
                title: `Request #${request.id} - ${request.blood_type}`,
                subtitle: `${request.hospital_name || 'Hospital'} ‚Ä¢ ${request.status}`,
                action: () => viewRequestDetails(request.id)
            });
        }
    });
    
    if (results.length === 0) {
        searchResults.innerHTML = `
            <div class="search-result-item">
                <div class="search-result-title">No results found</div>
                <div class="search-result-subtitle">Try a different search term</div>
            </div>
        `;
    } else {
        searchResults.innerHTML = results.slice(0, 10).map(result => `
            <div class="search-result-item" onclick='${result.action.toString().replace(/'/g, "\\'")}()'>
                <div class="search-result-type">${result.type}</div>
                <div class="search-result-title">${result.title}</div>
                <div class="search-result-subtitle">${result.subtitle}</div>
            </div>
        `).join('');
    }
    
    searchResults.classList.add('active');
}

// Close search results when clicking outside
document.addEventListener('click', function(e) {
    if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
        searchResults.classList.remove('active');
    }
});

// Initialize Dashboard
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardStats();
    
    // Refresh data every 30 seconds
    setInterval(() => {
        loadDashboardStats();
    }, 30000);
});
</script>
{% endblock %}