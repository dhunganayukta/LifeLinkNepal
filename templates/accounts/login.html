{% extends 'base.html' %}

{% block title %}Login - Life Link Nepal{% endblock %}

{% block extra_css %}
<style>
/* ... keep all your existing CSS unchanged ... */
</style>
{% endblock %}

{% block content %}
<div class="login-section">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="login-card">
                    <div class="login-card-body">
                        <div class="login-header">
                            <div class="icon-wrapper">
                                <i class="bi bi-shield-fill-check"></i>
                            </div>
                            <h3>Welcome Back</h3>
                            <p>Login to continue saving lives</p>
                        </div>

                        <div id="responseMessage"></div>

                        <form id="loginForm">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="username" class="form-label">
                                    <i class="bi bi-person-fill me-2"></i>Username
                                </label>
                                <input type="text" class="form-control" id="username" name="username" 
                                       placeholder="Enter your username" required autofocus>
                            </div>

                            <div class="mb-3">
                                <label for="password" class="form-label">
                                    <i class="bi bi-lock-fill me-2"></i>Password
                                </label>
                                <input type="password" class="form-control" id="password" name="password" 
                                       placeholder="Enter your password" required>
                            </div>

                            <button type="submit" class="btn btn-login btn-primary w-100">
                                <i class="bi bi-box-arrow-in-right me-2"></i>Login
                            </button>
                        </form>

                        <div class="divider">
                            <span>Don't have an account?</span>
                        </div>

                        <div class="register-options">
                            <a href="{% url 'accounts:register_page' %}?type=donor" class="register-option">
                                <i class="bi bi-heart-pulse-fill"></i>
                                <div class="option-title">Donor</div>
                                <p class="option-desc">Register to donate blood</p>
                            </a>
                            <a href="{% url 'accounts:register_page' %}?type=hospital" class="register-option">
                                <i class="bi bi-hospital-fill"></i>
                                <div class="option-title">Hospital</div>
                                <p class="option-desc">Register your hospital</p>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('loginForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const form = e.target;
    const data = Object.fromEntries(new FormData(form).entries());

    try {
        const response = await fetch("{% url 'accounts:login' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();
        const msgDiv = document.getElementById('responseMessage');

        if (response.ok) {
            // Save JWT token to localStorage
            localStorage.setItem('accessToken', result.access);
            localStorage.setItem('refreshToken', result.refresh);
            localStorage.setItem('userType', result.user_type);

            msgDiv.innerHTML = `<div class="alert alert-success">Login successful! Redirecting...</div>`;
            
            // Redirect to dashboard or home
            setTimeout(() => {
                if (result.user_type === 'donor') {
                    window.location.href = "{% url 'donor_dashboard' %}";
                    return;
                }
                else if (result.user_type === 'hospital') {
                    window.location.href = "{% url 'hospital_dashboard' %}";
                    return;
                }
               else {
                   window.location.href = "{% url 'accounts:login_page' %}";
               }

            }, 1000);
        } else {
            let errors = result.detail || JSON.stringify(result);
            msgDiv.innerHTML = `<div class="alert alert-danger">${errors}</div>`;
        }

    } catch (err) {
        console.error(err);
    }
});
</script>
{% endblock %}
