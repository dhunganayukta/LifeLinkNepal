{% extends 'base.html' %}
{% load static %}

{% block title %}Blood Request Details - Life Link Nepal{% endblock %}

{% block extra_css %}
<style>
    .info-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    }

    .fade-in-up {
        animation: fadeInUp 0.6s ease-out;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    body.dark-mode .info-card {
        background-color: #2d2d2d;
        color: #e0e0e0;
    }
</style>
{% endblock %}

{% block content %}
<!-- Header -->
<section class="py-4" style="background: linear-gradient(135deg, #c71e35 0%, #e53949 100%);">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center text-white flex-wrap">
            <div class="mb-3 mb-md-0">
                <h2 class="fw-bold mb-1">
                    <i class="bi bi-search me-2"></i>Blood Request Details
                </h2>
                <p class="mb-0">Donor information is privacy protected</p>
            </div>
            <div class="text-end">
                <a href="{% url 'hospital_dashboard' %}" class="btn btn-light">
                    <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
                </a>
            </div>
        </div>
    </div>
</section>

<section class="py-5">
    <div class="container">
        <div class="row">
            <!-- Main Content -->
            <div class="col-lg-8">
                <!-- Request Info Card -->
                <div class="info-card mb-4 fade-in-up" style="background: linear-gradient(135deg, rgba(199, 30, 53, 0.1) 0%, rgba(229, 57, 73, 0.1) 100%);">
                    <h4 class="fw-bold mb-3">
                        <i class="bi bi-clipboard-pulse text-danger me-2"></i>
                        Blood Request Details
                    </h4>
                    <div class="row g-3">
                        <div class="col-md-3">
                            <div class="text-center p-3 bg-white rounded">
                                <small class="text-muted d-block mb-1">Blood Type</small>
                                <h3 class="fw-bold text-danger mb-0">{{ blood_request.blood_type }}</h3>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3 bg-white rounded">
                                <small class="text-muted d-block mb-1">Units Needed</small>
                                <h3 class="fw-bold text-primary mb-0">{{ blood_request.units_needed }}</h3>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3 bg-white rounded">
                                <small class="text-muted d-block mb-1">Patient</small>
                                <h6 class="fw-bold mb-0">{{ blood_request.patient_name }}</h6>
                                {% if blood_request.patient_age %}
                                    <small class="text-muted">{{ blood_request.patient_age }} yrs</small>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3 bg-white rounded">
                                <small class="text-muted d-block mb-1">Urgency</small>
                                <span class="badge 
                                    {% if blood_request.urgency_level == 'critical' %}bg-danger
                                    {% elif blood_request.urgency_level == 'urgent' %}bg-warning text-dark
                                    {% else %}bg-success{% endif %} fs-6">
                                    {{ blood_request.urgency_level|upper }}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Status -->
                    <div class="mt-3 text-center">
                        <span class="badge 
                            {% if blood_request.status == 'fulfilled' %}bg-success
                            {% elif blood_request.status == 'pending' %}bg-warning text-dark
                            {% elif blood_request.status == 'cancelled' %}bg-secondary
                            {% else %}bg-info{% endif %} fs-5 px-4 py-2">
                            Status: {{ blood_request.status|upper }}
                        </span>
                    </div>
                </div>

                <!-- Privacy Notice -->
                <div class="alert alert-warning border-warning mb-4">
                    <i class="bi bi-shield-exclamation me-2"></i>
                    <strong>Privacy Protected:</strong> For donor safety, only username, blood type, and distance are visible. 
                    Full donor details are managed by admin. Admin will handle donor notifications.
                </div>

                <!-- Results Header -->
                <div class="info-card mb-4 fade-in-up">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="fw-bold mb-0">
                            <i class="bi bi-people-fill text-danger me-2"></i>
                            {{ total_donors_found }} Donors Found
                        </h4>
                        <span class="badge bg-info fs-6">
                            <i class="bi bi-cpu me-1"></i>Admin Managed
                        </span>
                    </div>
                </div>

                <!-- Accepted Donor (if any) -->
                {% if accepted_donor %}
                <div class="info-card mb-4 fade-in-up border-start border-5 border-success">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <h5 class="fw-bold text-success mb-0">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            Donor Accepted!
                        </h5>
                        <span class="badge bg-success fs-6">MATCHED</span>
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="text-center p-3 bg-light rounded">
                                <small class="text-muted d-block mb-1">Username</small>
                                <h6 class="fw-bold mb-0">@{{ accepted_donor.username }}</h6>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center p-3 bg-light rounded">
                                <small class="text-muted d-block mb-1">Blood Type</small>
                                <h5 class="fw-bold text-danger mb-0">{{ accepted_donor.blood_type }}</h5>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center p-3 bg-light rounded">
                                <small class="text-muted d-block mb-1">Distance</small>
                                <h6 class="fw-bold mb-0">
                                    {% if accepted_donor.distance %}
                                        {{ accepted_donor.distance }} km
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </h6>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-3 mb-0">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        <strong>Next Steps:</strong> The donor will contact you directly through the admin. 
                        Please coordinate donation details.
                    </div>
                </div>
                {% endif %}

                <!-- Donors List (LIMITED INFO) -->
                {% if donor_data %}
                    <h5 class="fw-bold mb-3">
                        <i class="bi bi-list-ul me-2"></i>Queued Donors (Top {{ donor_data|length }})
                    </h5>
                    {% for donor in donor_data %}
                    <div class="info-card mb-3 fade-in-up"
                        style="animation-delay: {{ forloop.counter0|stringformat:'d' }}00ms;">
                        
                        <!-- Donor Header -->
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="d-flex align-items-center">
                                <div class="bg-danger bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-3" 
                                     style="width: 50px; height: 50px;">
                                    <i class="bi bi-person-fill text-danger fs-4"></i>
                                </div>
                                <div>
                                    <h5 class="fw-bold mb-0">@{{ donor.username }}</h5>
                                    <small class="text-muted">Anonymous Donor</small>
                                </div>
                            </div>
                            <span class="badge bg-{{ donor.status|lower }} fs-6">
                                {{ donor.status }}
                            </span>
                        </div>

                        <!-- LIMITED Metrics -->
                        <div class="row g-2">
                            <div class="col-4">
                                <div class="bg-light rounded p-2 text-center">
                                    <div class="text-danger fw-bold fs-5">{{ donor.blood_type }}</div>
                                    <small class="text-muted">Blood Type</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="bg-light rounded p-2 text-center">
                                    <div class="text-primary fw-bold fs-5">
                                        {% if donor.distance %}
                                            {{ donor.distance }} km
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </div>
                                    <small class="text-muted">Distance</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="bg-light rounded p-2 text-center">
                                    <div class="text-muted fw-bold fs-5">
                                        <i class="bi bi-shield-lock-fill"></i>
                                    </div>
                                    <small class="text-muted">Private</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        <strong>Note:</strong> Admin is managing donor notifications sequentially. 
                        You will be notified when a donor accepts.
                    </div>
                {% else %}
                    <div class="info-card text-center py-5 fade-in-up">
                        <i class="bi bi-search text-muted" style="font-size: 4rem;"></i>
                        <h4 class="text-muted mt-3">No Matching Donors Found</h4>
                        <p class="text-muted">No compatible donors are currently available within 50km</p>
                        <a href="{% url 'hospital_donors' %}" class="btn btn-primary mt-3">
                            <i class="bi bi-search"></i> Browse All Donors
                        </a>
                    </div>
                {% endif %}
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Request Actions -->
                <div class="info-card fade-in-up mb-4">
                    <h5 class="fw-bold mb-3">
                        <i class="bi bi-gear text-danger me-2"></i>
                        Request Actions
                    </h5>
                    
                    {% if blood_request.status == 'pending' %}
                    <form method="POST" action="{% url 'mark_fulfilled' blood_request.id %}" class="mb-2">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{{ request.path }}">
                        <button type="submit" class="btn btn-success w-100" onclick="return confirm('Mark this request as fulfilled?');">
                            <i class="bi bi-check-circle me-2"></i>Mark as Fulfilled
                        </button>
                    </form>
                    
                    <a href="{% url 'cancel_request' blood_request.id %}" 
                       class="btn btn-outline-danger w-100"
                       onclick="return confirm('Cancel this blood request?');">
                        <i class="bi bi-x-circle me-2"></i>Cancel Request
                    </a>
                    {% elif blood_request.status == 'fulfilled' %}
                    <div class="alert alert-success mb-0">
                        <i class="bi bi-check-circle-fill me-2"></i>
                        This request has been fulfilled!
                    </div>
                    {% elif blood_request.status == 'cancelled' %}
                    <div class="alert alert-secondary mb-0">
                        <i class="bi bi-x-circle-fill me-2"></i>
                        This request has been cancelled.
                    </div>
                    {% endif %}
                </div>
                
                <!-- Algorithm Info -->
                <div class="info-card fade-in-up mb-4">
                    <h5 class="fw-bold mb-3">
                        <i class="bi bi-cpu text-danger me-2"></i>
                        Matching Process
                    </h5>
                    <div class="mb-3 pb-3 border-bottom">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-1-circle-fill text-primary me-2 fs-5"></i>
                            <strong>Find Compatible Donors</strong>
                        </div>
                        <small class="text-muted">System searches for donors with compatible blood type within 50km</small>
                    </div>
                    <div class="mb-3 pb-3 border-bottom">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-2-circle-fill text-warning me-2 fs-5"></i>
                            <strong>Rank Using AI</strong>
                        </div>
                        <small class="text-muted">MCDM algorithm ranks donors by distance, history, and compatibility</small>
                    </div>
                    <div>
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-3-circle-fill text-success me-2 fs-5"></i>
                            <strong>Admin Notifies</strong>
                        </div>
                        <small class="text-muted">Admin manages sequential donor notifications until one accepts</small>
                    </div>
                </div>

                <!-- Privacy Info -->
                <div class="info-card bg-light fade-in-up" style="animation-delay: 0.2s;">
                    <h5 class="fw-bold mb-3">
                        <i class="bi bi-shield-check text-success me-2"></i>
                        Privacy Protection
                    </h5>
                    <div class="mb-2">
                        <i class="bi bi-check-circle text-success me-2"></i>
                        <small>Only basic info shown</small>
                    </div>
                    <div class="mb-2">
                        <i class="bi bi-check-circle text-success me-2"></i>
                        <small>Full details via admin only</small>
                    </div>
                    <div class="mb-2">
                        <i class="bi bi-check-circle text-success me-2"></i>
                        <small>Donor safety prioritized</small>
                    </div>
                    <div>
                        <i class="bi bi-check-circle text-success me-2"></i>
                        <small>Contact through platform</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}